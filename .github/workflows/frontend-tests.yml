name: Frontend Tests

on:
  push:
    branches: [main, develop]
    paths:
      - "src/**"
      SHOULD_SKIP_FRONTEND: ${{
        (github.event_name == 'push' && (
          contains(github.event.head_commit.message, '[skip ci]') ||
          contains(github.event.head_commit.message, '[skip frontend]')
        )) ||
        (github.event_name == 'pull_request' && (
          contains(github.event.pull_request.title, '[skip ci]') ||
          contains(github.event.pull_request.title, '[skip frontend]') ||
          contains(github.event.pull_request.body || '', '[skip ci]') ||
          contains(github.event.pull_request.body || '', '[skip frontend]')
        ))
      }}

concurrency:
  group: frontend-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20.x"
  SHOULD_SKIP_FRONTEND: >-
    ${{
      (github.event_name == 'push' && (
        contains(github.event.head_commit.message, '[skip ci]') ||
        contains(github.event.head_commit.message, '[skip frontend]')
      )) ||
      (github.event_name == 'pull_request' && (
        contains(github.event.pull_request.title, '[skip ci]') ||
        contains(github.event.pull_request.title, '[skip frontend]') ||
        contains(github.event.pull_request.body || '', '[skip ci]') ||
        contains(github.event.pull_request.body || '', '[skip frontend]')
      ))
    }}

jobs:
  quality:
    name: Lint, Unit Tests & Build
    if: ${{ env.SHOULD_SKIP_FRONTEND != 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint source
        run: npm run lint

      - name: Run Vitest suite
        run: npm run test:coverage -- --reporter=verbose
        env:
          CI: true

      - name: Build for production
        run: npm run build
        env:
          CI: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

      - name: Upload production build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist
          retention-days: 5

  accessibility-audit:
    name: Axe Accessibility Audit
    if: ${{ env.SHOULD_SKIP_FRONTEND != 'true' }}
    needs: quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist

      - name: Run axe accessibility audit
        run: npx @axe-core/cli@4.9.1 dist --exit

  playwright-e2e:
    name: Playwright Smoke Tests
    if: ${{ env.SHOULD_SKIP_FRONTEND != 'true' }}
    needs: quality
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: npx playwright test --config=playwright.config.ts --reporter=line
        env:
          CI: true
